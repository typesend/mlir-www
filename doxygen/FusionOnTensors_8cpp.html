<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MLIR: lib/Dialect/Linalg/Transforms/FusionOnTensors.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MLIR
   &#160;<span id="projectnumber">17.0.0git</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_1a25ec519b6c1121408b67cc33ce3f15.html">Dialect</a></li><li class="navelem"><a class="el" href="dir_8edb792440615361a0811a7329611599.html">Linalg</a></li><li class="navelem"><a class="el" href="dir_7e2f808e77498894ca0efbd745da2201.html">Transforms</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">FusionOnTensors.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="SliceAnalysis_8h_source.html">mlir/Analysis/SliceAnalysis.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="AffineOps_8h_source.html">mlir/Dialect/Affine/IR/AffineOps.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mlir_2Dialect_2Linalg_2IR_2Linalg_8h_source.html">mlir/Dialect/Linalg/IR/Linalg.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="Dialect_2Linalg_2Passes_8h_source.html">mlir/Dialect/Linalg/Passes.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mlir_2Dialect_2Linalg_2Transforms_2Transforms_8h_source.html">mlir/Dialect/Linalg/Transforms/Transforms.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="Dialect_2Linalg_2Utils_2Utils_8h_source.html">mlir/Dialect/Linalg/Utils/Utils.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mlir_2Dialect_2Tensor_2IR_2Tensor_8h_source.html">mlir/Dialect/Tensor/IR/Tensor.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="Utils_2IndexingUtils_8h_source.html">mlir/Dialect/Utils/IndexingUtils.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mlir_2IR_2AffineExpr_8h_source.html">mlir/IR/AffineExpr.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mlir_2IR_2AffineMap_8h_source.html">mlir/IR/AffineMap.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mlir_2Support_2LLVM_8h_source.html">mlir/Support/LLVM.h</a>&quot;</code><br />
<code>#include &lt;optional&gt;</code><br />
</div>
<p><a href="FusionOnTensors_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a739c83a04b96a2c13e47d430bb5dd5d5"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="classllvm_1_1SmallVector.html">SmallVector</a>&lt; int64_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="FusionOnTensors_8cpp.html#a739c83a04b96a2c13e47d430bb5dd5d5">getTiledSliceDims</a> (<a class="el" href="classmlir_1_1OpOperand.html">OpOperand</a> *consumerOperand, <a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt; tiledLoopDims)</td></tr>
<tr class="memdesc:a739c83a04b96a2c13e47d430bb5dd5d5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns the tiled slice dimensions given the tiled consumer loop dimensions.  <a href="FusionOnTensors_8cpp.html#a739c83a04b96a2c13e47d430bb5dd5d5">More...</a><br /></td></tr>
<tr class="separator:a739c83a04b96a2c13e47d430bb5dd5d5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adaa1e370f6b0548876aaad87d5c173d4"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="classllvm_1_1SmallVector.html">SmallVector</a>&lt; int64_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="FusionOnTensors_8cpp.html#adaa1e370f6b0548876aaad87d5c173d4">getTiledProducerLoops</a> (<a class="el" href="classmlir_1_1OpResult.html">OpResult</a> producerResult, <a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt; tiledSliceDimIndices)</td></tr>
<tr class="memdesc:adaa1e370f6b0548876aaad87d5c173d4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Given a vector of <code>tiledSliceDimIndices</code> that represent the tiled dimensions of the producer result slice returns the tiled producer loop dimensions.  <a href="FusionOnTensors_8cpp.html#adaa1e370f6b0548876aaad87d5c173d4">More...</a><br /></td></tr>
<tr class="separator:adaa1e370f6b0548876aaad87d5c173d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0ed154233dbf0a242c86b0146a11dd5c"><td class="memItemLeft" align="right" valign="top">static LinalgOp&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="FusionOnTensors_8cpp.html#a0ed154233dbf0a242c86b0146a11dd5c">getTiledProducer</a> (<a class="el" href="classmlir_1_1OpBuilder.html">OpBuilder</a> &amp;b, <a class="el" href="classmlir_1_1OpResult.html">OpResult</a> producerResult, tensor::ExtractSliceOp sliceOp, <a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt; tiledSliceDimIndices, <a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt; tiledProducerLoopIndices, <a class="el" href="classmlir_1_1OpOperand.html">OpOperand</a> *iterArg)</td></tr>
<tr class="memdesc:a0ed154233dbf0a242c86b0146a11dd5c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns the producer fused in place of <code>sliceOp</code>.  <a href="FusionOnTensors_8cpp.html#a0ed154233dbf0a242c86b0146a11dd5c">More...</a><br /></td></tr>
<tr class="separator:a0ed154233dbf0a242c86b0146a11dd5c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a0ed154233dbf0a242c86b0146a11dd5c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ed154233dbf0a242c86b0146a11dd5c">&#9670;&nbsp;</a></span>getTiledProducer()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static LinalgOp getTiledProducer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classmlir_1_1OpBuilder.html">OpBuilder</a> &amp;&#160;</td>
          <td class="paramname"><em>b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1OpResult.html">OpResult</a>&#160;</td>
          <td class="paramname"><em>producerResult</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tensor::ExtractSliceOp&#160;</td>
          <td class="paramname"><em>sliceOp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt;&#160;</td>
          <td class="paramname"><em>tiledSliceDimIndices</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt;&#160;</td>
          <td class="paramname"><em>tiledProducerLoopIndices</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1OpOperand.html">OpOperand</a> *&#160;</td>
          <td class="paramname"><em>iterArg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Returns the producer fused in place of <code>sliceOp</code>. </p>
<p>Tile the producer operands along the <code>tiledSliceDimIndices</code> and clone the producer. Consider the case of fusion of an output tensor: </p><div class="fragment"><div class="line">%1 = producer ins(...) outs(%0)</div>
<div class="line">%2 = consumer ins(...) outs(%1)</div>
</div><!-- fragment --><p> When consumer is tiled, %1 appears in the loop iter_args: </p><div class="fragment"><div class="line">%1 = producer ins(...) outs(%0)</div>
<div class="line">%2 = scf.for ... iter_args(%1) .. (%bbarg) {</div>
<div class="line">  %t1 = tensor.extract_slice %bbarg[..]</div>
<div class="line">  %t2 = consumer ins(...) outs(%t1)</div>
<div class="line">  %r = tensor.insert_slice %t2, %bbarg[...]</div>
<div class="line">}</div>
</div><!-- fragment --><p> Fusing %1 into the loop requires updating iter_args(%1) to iter_args(%0): </p><div class="fragment"><div class="line">%2 = scf.for ... iter_args(%0) .. (%bbarg) {</div>
<div class="line">  %t0 = tensor.extract_slice %bbarg[..]</div>
<div class="line">  %t1 = producer ins(...) outs(%t0)</div>
<div class="line">  %t2 = consumer ins(...) outs(%t1)</div>
<div class="line">  %r = tensor.insert_slice %t2, %bbarg[...]</div>
<div class="line">}</div>
</div><!-- fragment --><p> This transformation is only valid if bbarg is exclusively used by the output ExtractSliceOp / InsertSliceOp pair, which is checked by the <code>fuseProducer</code> method. TODO: instead of check and failure, insert new iter_args each time a producer is fused into a consumer and fold away unused iter_args. </p>
<p>omitPartialTileCheck=</p>

<p class="definition">Definition at line <a class="el" href="FusionOnTensors_8cpp_source.html#l00129">129</a> of file <a class="el" href="FusionOnTensors_8cpp_source.html">FusionOnTensors.cpp</a>.</p>

<p class="reference">References <a class="el" href="StructuredOpsUtils_8cpp_source.html#l00099">mlir::clone()</a>, <a class="el" href="UseDefLists_8h_source.html#l00137">mlir::IROperand&lt; DerivedT, IRValueT &gt;::get()</a>, <a class="el" href="Builders_8cpp_source.html#l00121">mlir::Builder::getIndexAttr()</a>, <a class="el" href="Value_8cpp_source.html#l00212">mlir::OpOperand::getOperandNumber()</a>, <a class="el" href="Value_8h_source.html#l00451">mlir::OpResult::getOwner()</a>, <a class="el" href="Value_8h_source.html#l00454">mlir::OpResult::getResultNumber()</a>, <a class="el" href="classmlir_1_1ValueRange.html#ab8f3a1aeea4da0acfaad1bc71b072017">mlir::ValueRange::getTypes()</a>, <a class="el" href="Dialect_2Linalg_2Utils_2Utils_8cpp_source.html#l00909">mlir::linalg::makeTiledShapes()</a>, <a class="el" href="Dialect_2Linalg_2Utils_2Utils_8cpp_source.html#l00930">mlir::linalg::offsetIndices()</a>, <a class="el" href="UseDefLists_8h_source.html#l00140">mlir::IROperand&lt; DerivedT, IRValueT &gt;::set()</a>, and <a class="el" href="Builders_8h_source.html#l00393">mlir::OpBuilder::setInsertionPointAfter()</a>.</p>

<p class="reference">Referenced by <a class="el" href="FusionOnTensors_8cpp_source.html#l00327">mlir::linalg::TileLoopNest::fuseProducer()</a>.</p>

</div>
</div>
<a id="adaa1e370f6b0548876aaad87d5c173d4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adaa1e370f6b0548876aaad87d5c173d4">&#9670;&nbsp;</a></span>getTiledProducerLoops()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="classllvm_1_1SmallVector.html">SmallVector</a>&lt;int64_t&gt; getTiledProducerLoops </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classmlir_1_1OpResult.html">OpResult</a>&#160;</td>
          <td class="paramname"><em>producerResult</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt;&#160;</td>
          <td class="paramname"><em>tiledSliceDimIndices</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Given a vector of <code>tiledSliceDimIndices</code> that represent the tiled dimensions of the producer result slice returns the tiled producer loop dimensions. </p>
<p>Example: </p><div class="fragment"><div class="line">%res = linalg.fill(%cst, %input)</div>
<div class="line">scf.for %i</div>
<div class="line">  scf.for %<a class="code" href="unionj.html">j</a></div>
<div class="line">    %slice = tensor.extract_slice %res[%i, %<a class="code" href="unionj.html">j</a>]</div>
<div class="ttc" id="aunionj_html"><div class="ttname"><a href="unionj.html">j</a></div><div class="ttdoc">Eliminates variable at the specified position using Fourier-Motzkin variable elimination.</div></div>
</div><!-- fragment --><p> getTiledProducerLoops(res, [0, 1]) returns the loop indices [0, 1]. </p>

<p class="definition">Definition at line <a class="el" href="FusionOnTensors_8cpp_source.html#l00066">66</a> of file <a class="el" href="FusionOnTensors_8cpp_source.html">FusionOnTensors.cpp</a>.</p>

<p class="reference">References <a class="el" href="IR_2AffineMap_8cpp_source.html#l00332">mlir::AffineMap::getNumResults()</a>, <a class="el" href="Value_8h_source.html#l00451">mlir::OpResult::getOwner()</a>, <a class="el" href="Value_8h_source.html#l00454">mlir::OpResult::getResultNumber()</a>, <a class="el" href="IR_2AffineMap_8cpp_source.html#l00557">mlir::AffineMap::getSubMap()</a>, and <a class="el" href="IR_2AffineMap_8cpp_source.html#l00521">mlir::AffineMap::isProjectedPermutation()</a>.</p>

<p class="reference">Referenced by <a class="el" href="FusionOnTensors_8cpp_source.html#l00327">mlir::linalg::TileLoopNest::fuseProducer()</a>.</p>

</div>
</div>
<a id="a739c83a04b96a2c13e47d430bb5dd5d5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a739c83a04b96a2c13e47d430bb5dd5d5">&#9670;&nbsp;</a></span>getTiledSliceDims()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="classllvm_1_1SmallVector.html">SmallVector</a>&lt;int64_t&gt; getTiledSliceDims </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classmlir_1_1OpOperand.html">OpOperand</a> *&#160;</td>
          <td class="paramname"><em>consumerOperand</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; int64_t &gt;&#160;</td>
          <td class="paramname"><em>tiledLoopDims</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Returns the tiled slice dimensions given the tiled consumer loop dimensions. </p>
<p>The slice defines a hyper rectangular iteration space and fusing the producer is always possible. However, depending on the consumer indexing map, not all slice elements may be consumed and the tiles may overlap. In these cases, fusion introduces redundant computation. </p>

<p class="definition">Definition at line <a class="el" href="FusionOnTensors_8cpp_source.html#l00038">38</a> of file <a class="el" href="FusionOnTensors_8cpp_source.html">FusionOnTensors.cpp</a>.</p>

<p class="reference">References <a class="el" href="Matchers_8h_source.html#l00262">mlir::detail::enumerate()</a>, <a class="el" href="UseDefLists_8h_source.html#l00040">mlir::detail::IROperandBase::getOwner()</a>, and <a class="el" href="IR_2AffineMap_8cpp_source.html#l00337">mlir::AffineMap::getResults()</a>.</p>

<p class="reference">Referenced by <a class="el" href="FusionOnTensors_8cpp_source.html#l00327">mlir::linalg::TileLoopNest::fuseProducer()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu May 4 2023 20:34:09 for MLIR by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
